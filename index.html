
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>irodori</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" type="text/css" href="./lib/jquery-easyui-1.5.5.2/themes/metro-orange/easyui.css">
    <link rel="stylesheet" type="text/css" href="./lib/jquery-easyui-1.5.5.2/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="./lib/jquery-easyui-1.5.5.2/themes/color.css">
    <script type="text/javascript" src="./lib/jquery-easyui-1.5.5.2/jquery.min.js"></script>
    <script>window.$ = window.jQuery = require('jquery');</script>
    <script type="text/javascript" src="./lib/jquery-easyui-1.5.5.2/jquery.easyui.min.js"></script>
    <script src="./lib/ace/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
  </head>
    <link rel="stylesheet" type="text/css" href="./css/irodori.css">
  <body>
    <div id="header-fixed" style="display:none">
      <table>
        <tr>
          <td><img border="0" src="./img/irodori-icon.ico" width="16" height="16" alt="img" style="vertical-align:middle"></td> 
          <td><span style="color:#FFF">irodori</span></td> 
          <td width="20px"></td> 
        </tr> 
      </table> 
    </div> 

    <div id="editor" style=""></div>

    <div id="footer-fixed-upper"></div> 

    <div id="footer-fixed"> 
      <span id="btnDevTools" class="icon icon-power" style="color:#FFF;font-size:9px;margin-left:1px;cursor:pointer"></span>
      <select id="inputMode" style="font-size:10px; background-color:#444; color:#FFF">
      <option value="normal">Normal</option>
      <option value="vim">Vim</option>
      <option value="emacs">Emacs</option>
      </select>
      <span id="outEval" style="color:#FFF;">&nbsp;</span>
      <span id="outSave" style="color:#FFF;"></span> 
      <iframe id="sandbox" src="./sandbox.html" style="display:none"></iframe>
    </div> 
  </body>
  <script src="./lib/underscore.js"></script>
  <script>
    var global = this;
    var electron = require('electron');
    var irodori = electron.remote.require('./irodori');

    var lastClip = "";
    var clips = [""];
    var clipIndex = 0;
    var saveTimer = null;

    var editor = null;

    function getContent() {
      return editor.getValue();
    }

    function formatDateTime(d) {
        var y = d.getFullYear();
        var m = d.getMonth() + 1;
        var dd = d.getDate();
        var hh = d.getHours();
        var mm = d.getMinutes();
        var ss = d.getSeconds();
        var y0 = ('0000' + y).slice(-4);
        var m0 = ('00' + m).slice(-2);
        var d0 = ('00' + dd).slice(-2);
        var hx = ('00' + hh).slice(-2);
        var mx = ('00' + mm).slice(-2);
        var sx = ('00' + ss).slice(-2);
        return y0 + "/" + m0 + "/" + d0 + " " + hx + ":" + mx + ":" + sx  ;
    }

    var someContext = {};

    function compileCode (src) {
      src = 'with (sandbox) {' + src + '}'
      return new Function('sandbox', src)
    }

    function subContext () {}

    var sc = new subContext();

    function safeEval(script,after) {
      iframe = document.getElementById("sandbox");
      iframe.contentWindow.___safeEval___(script,
        function(result,err) { 
          if(err) {
            $(".out_script").remove();
            $("#outEval").append('<span class="out_script icon icon-cancel-circle" style="color:#FAA">' + "" + '</span>');
            console.log(err);
          } else {
            $(".out_script").remove();
            $("#outEval").append('<span class="out_script icon icon-checkmark" style="color:#AFA">' + "" + '</span>');
            console.log(result); 
          }

          if(after) {
            after(result,err);
          }
        });
    }

    function unsafeEval(script, after) {
      var result = undefined;
      try {
        // result = eval.call(global, script);
        result = eval.call(global,script);
        if(after) {
          after(result,undefined);
        }
      } catch(ex) {
        if(after) {
          after(result,ex);
        }
      }
    }

    $(document).ready(function() {
      editor = ace.edit("editor");
      //editor.setTheme("ace/theme/github");
      //editor.setTheme("ace/theme/twilight");
      //editor.setTheme("ace/theme/monokai");
      editor.session.setMode("ace/mode/markdown");
      //editor.session.setMode("ace/mode/lisp");

      editor.setOptions({
        fontFamily: "ＭＳ ゴシック",
        fontSize: "12px"
      });

      irodori.readData(function(err,data) {
        if(err) {
          editor.setValue("", -1);
        } else {
          editor.setValue(data, -1);
        }
      });

      $("#btnDevTools").click(function() {
        irodori.openDevTools();
      });



      $(window).on("beforeunload",function(e){
          irodori.writeData(getContent(), function() {});
      });

      $(document).keydown(function(e) {
        if((e.keyCode == 13) && (e.ctrlKey) && !(e.shiftKey)) {
          var script = editor.getSelectedText();
          console.log("$ " + script);

          // TODO : launch
          // irodori.execProc(script);
          irodori.execProc(script, function(err, stdout, stderr) {
          // irodori.execProcFile(script, function(err, stdout, stderr) {
            console.log(stdout);
            console.log(stderr);

            // var range = editor.getSelectionRange();
            // var endLine = range.end.row;
            // if(result) {
            //   editor.session.insert({row:endLine + 1,column:0}, "> " + result.toString() + "\n");
            // } else {
            //   editor.session.insert({row:endLine + 1,column:0}, "> " + err.toString() + "\n");
            // }

          });
        }
        if((e.keyCode == 13) && (e.ctrlKey) && (e.shiftKey)) {
          var script = editor.getSelectedText();
          console.log("$ " + script);

          // TODO : launch
          // irodori.execProc(script);
          irodori.execProc(script, function(err, stdout, stderr) {
          // irodori.execProcFile(script, function(err, stdout, stderr) {
            console.log(err);
            console.log(stdout);
            console.log(stderr);

            var range = editor.getSelectionRange();
            var endLine = range.end.row;

            editor.session.insert({row:endLine + 1,column:0}, "" + stdout.toString() + "\n");
            editor.session.insert({row:endLine + 1,column:0}, "" + stderr.toString() + "\n");

            if(stdout) {
              editor.session.insert({row:endLine + 1,column:0}, "" + stdout.toString() + "\n");
            }
            // else {
            //   editor.session.insert({row:endLine + 1,column:0}, "> " + err.toString() + "\n");
            // }

          });
        }

        if((e.keyCode == 74) && (e.ctrlKey) && !(e.shiftKey)) {
          var script = editor.getSelectedText();
          console.log("> " + script);

          safeEval(script);
        }

        if((e.keyCode == 74) && (e.ctrlKey) && (e.shiftKey)) {
          var script = editor.getSelectedText();
          console.log("> " + script);

          safeEval(script, function(result,err) {
            var range = editor.getSelectionRange();
            var endLine = range.end.row;
            if(result) {
              editor.session.insert({row:endLine + 1,column:0}, "> " + result.toString() + "\n");
            } else {
              editor.session.insert({row:endLine + 1,column:0}, "> " + err.toString() + "\n");
            }
          });
        }

        if((e.keyCode == 71) && (e.ctrlKey) && !(e.shiftKey)) {
          var script = editor.getSelectedText();
          console.log("> " + script);

          unsafeEval(script);
        }

        if((e.keyCode == 71) && (e.ctrlKey) && (e.shiftKey)) {
          var script = editor.getSelectedText();
          console.log("> " + script);

          unsafeEval(script, function(result,err) {
            var range = editor.getSelectionRange();
            var endLine = range.end.row;
            if(result) {
              editor.session.insert({row:endLine + 1,column:0}, "> " + result.toString() + "\n");
            } else {
              editor.session.insert({row:endLine + 1,column:0}, "> " + err.toString() + "\n");
            }
          });
        }

      });

      editor.getSession().on('change', function() {
        if(saveTimer) {
          clearTimeout(saveTimer);
        }
        // console.log("save queued");
        saveTimer = setTimeout(function() {
          irodori.writeData(getContent(), function() {});
          // console.log("saved");
          // $("#span-saved").css("display", "none");
          // $("#span-saved").css("display", "inline");
          // $("#span-saved").text("SAVED : " + formatDateTime(new Date()));
        
          $(".out").remove();
          $("#outSave").append('<span class="out">'+"SAVED : " + formatDateTime(new Date())+'</span>');
          


            // var text = "";
            // text += "#shell(foo)\n";
            // text += "start notepad\n";
            // text += "#end";

            // var lines = text.split("\n");
            var lines = getContent().split("\n");
            var ex = new RegExp(/^\#shell\((.*)\)/);
            var exSc = new RegExp(/^\#script\((.*)\)/);
            var exEnd = new RegExp(/^\#end/);
            var fns = {};
            var fnsSc = {};
            var currentFn = null;
            var isShell = null;
            for(var i = 0; i < lines.length; i+=1) {
                var mt = lines[i].match(ex);
                if(mt) {
                    console.log("hit", mt[1]);
                    currentFn = mt[1];
                    fns[currentFn] = "";
                    isShell = true;
                    continue;
                }
                var mtSc = lines[i].match(exSc);
                if(mtSc) {
                    console.log("hit", mtSc[1]);
                    currentFn = mtSc[1];
                    fnsSc[currentFn] = "";
                    isShell = false;
                    continue;
                }
                var mtEnd = lines[i].match(exEnd);
                if(mtEnd) {
                    currentFn = null;
                  isShell = null;
                    continue;
                }
                if(currentFn) {
                    if(isShell) {
                      fns[currentFn] = fns[currentFn] + lines[i] + "\n";
                    } else {
                      fnsSc[currentFn] = fnsSc[currentFn] + lines[i] + "\n";
                    }
                    continue;
                }
                console.log("end proc", lines[i]);
            }

            $(".span-button").remove();
            $(".span-button-script").remove();
            _.mapObject(fns,function(val,key) {
                var elem = $('<span class="span-button">'+key+'</span>');
                elem.click(function() { 
                    console.log("[" + key + "] executed"); 
                    irodori.execProc(val);
                    //irodori.execProcFile(val);
                });
                $("#footer-fixed-upper").append(elem);
            });
            _.mapObject(fnsSc,function(val,key) {
                var elem = $('<span class="span-button-script">'+key+'</span>');
                elem.click(function() { 
                    console.log("[" + key + "] executed"); 
                    //irodori.execProc(val);
                    safeEval(val);
                });
                $("#footer-fixed-upper").append(elem);
            });

            $("#footer-fixed-upper").css("height","");


          // setTimeout(function() {
          //   $("#span-saved").css("display", "none");
          // }, 2900);
        }, 1000);
      });

      $(document).keyup(function(e) {

        // if(saveTimer) {
        //   clearTimeout(saveTimer);
        // }
        // // console.log("save queued");
        // saveTimer = setTimeout(function() {
        //   irodori.writeData(getContent(), function() {});
        //   // console.log("saved");
        //   // $("#span-saved").css("display", "none");
        //   // $("#span-saved").css("display", "inline");
        //   // $("#span-saved").text("SAVED : " + formatDateTime(new Date()));
        // 
        //   $(".out").remove();
        //   $("#outSave").append('<span class="out">'+"SAVED : " + formatDateTime(new Date())+'</span>');
        //   

        //   // setTimeout(function() {
        //   //   $("#span-saved").css("display", "none");
        //   // }, 2900);
        // }, 1000);

        switch (e.which){
          case 38: //Enter
            clipIndex -= 1;
            if(clipIndex < 0) {
              clipIndex = 0;
            }
            $("#clips").val(clips[clipIndex]);
            break;
          // case 40: //Esc
          //   clipIndex += 1;
          //   if(clipIndex >= clips.length) {
          //     clipIndex = clips.length - 1;
          //   }
          //   $("#clips").val(clips[clipIndex]);
          //   break;
        }
        $("#clipIndex").text(clipIndex);
      });


      // $(document).keyup(function(e) {
      //   switch (e.which){
      //     case 13: //Enter
      //       break;
      //     // case 27: //Esc
      //     //   tbCmd.val("");
      //     //   resetCandidate(irodori.getRecent());
      //     //   irodori.hideWindow();
      //     //   break;
      //   }
      // });

      $("#inputMode").change(function(e) {
        console.log("input mode changed");
        var val = $("#inputMode").val();
        if(val === "vim") {
          editor.setKeyboardHandler("ace/keyboard/vim");
        } else if(val === "emacs") {
          editor.setKeyboardHandler("ace/keyboard/emacs");
        } else {
          editor.setKeyboardHandler(null);
        }
      });
    });
  </script>
</html>

